<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Textbook Helper</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script type="importmap">
		  {
			"imports": {
			  "@google/generative-ai": "https://esm.run/@google/generative-ai"
			}
		  }
		</script>	
		<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/showdown@2.0.3/dist/showdown.min.js"></script>
		<link rel="stylesheet" href="styles.css">
	</head>
	
	<body>
		<!-- ... Your HTML and CSS -->
		<!-- Import @google/generative-ai, as shown above. -->
		<script type="module">
			import { HarmBlockThreshold, HarmCategory, GoogleGenerativeAI } from "@google/generative-ai";

			// Default export is a4 paper, portrait, using millimeters for units
			// Fetch your API_KEY
			const API_KEY = "AIzaSyD9xMiW0oSglYPfQh95Rn0TRHpjTZFduaE";

			// Access your API key (see "Set up your API key" above)
			const genAI = new GoogleGenerativeAI(API_KEY);
			
			const safetySettings = [
			  {
				category: HarmCategory.HARM_CATEGORY_HARASSMENT,
				threshold: HarmBlockThreshold.BLOCK_NONE,
			  },
			  {
				category: HarmCategory.HARM_CATEGORY_HATE_SPEECH,
				threshold: HarmBlockThreshold.BLOCK_NONE,
			  },
			  {
				category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT,
				threshold: HarmBlockThreshold.BLOCK_NONE,
			  },
			  {
				category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT,
				threshold: HarmBlockThreshold.BLOCK_NONE,
			  },
			];
			
			const startingPrompts = [
				"For loops in Python",
				"Introductory Algebra",
				"Basics of Cooking",
				"First steps in C++",
				"Formal writing"
			];
			
			const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash-exp-0827", systemInstruction: "You write textbooks and sections for textbooks and are detailed and informative. You write so beginners can understand, but provide depth and complexity.", safetySettings});
			
			var body;
			var textbox;
			var converter = new showdown.Converter();
			var status;
			
			var bookDict = {};
			
			function printDiv(txt, title) {
			  let mywindow = window.open('', 'PRINT', 'height=650,width=900,top=100,left=150');

			  mywindow.document.write(`<html><head><title>${title}</title>`);
			  mywindow.document.write('</head><body >');
			  mywindow.document.write(txt);
			  mywindow.document.write('</body></html>');

			  mywindow.document.close(); // necessary for IE >= 10
			  mywindow.focus(); // necessary for IE >= 10*/

			  mywindow.print();
			  mywindow.close();

			  return true;
			}
			
			function playSound(url) {
			  const audio = new Audio(url);
			  audio.play();
			}
			
			function updateListBox() {
				var select = document.getElementById('pagedict');
				select.innerHTML = "";
				for (const key in bookDict){
					var opt = document.createElement('option');
					opt.value = key;
					opt.innerHTML = key;
					select.appendChild(opt);
				}
			}
			
			function resetBook() {
				bookDict = {};
				updateListBox();
			}
			
			function fullBook() {
				let fullText = "";
				let i = 0;
				for (const key in bookDict) {

					fullText += `Page ${i}: ${key}\n\n` + bookDict[key] + "\n\n\n";
					i+=1;
				}
				fullText = fullText.replace(/<code>.*?<\/code>/gs, '');
				return fullText;
			}
			
			function addToBook(key,value) {
				bookDict[key] = value;
				updateListBox();
			}
			
			function setPage(key) {
				window.scrollTo({ top: 0, behavior: 'smooth' });
				body.innerHTML = bookDict[key];
			}
			
			async function generateBook() {
				let topic = textbox.value.trim();
				if (topic == "") {
					alert("Please provide a prompt! Example: How to write Python code");
					return;
				}
				resetBook();
				
				let tpcPrompt = `Write a list of ${document.getElementById("quantity").value} topics relating to ${topic}. Do not include a title or header for the list or any extra newlines. Only include the list elements with numbers. Use ONLY ASCII-safe characters. The first page should ALWAYS be a page talking broadly about the concept. Do not pick redundant topics. Do not provide anything in your response other than the list. Make sure each page covers a different aspect of ${topic}. Do not describe or provide detail to each topic here, only list them.`;
				console.log(tpcPrompt);
				status.textContent = "Creating list of pages";
				let topicResponse = await generateResponse(tpcPrompt);
				let topics = topicResponse.split('\n');
				topics = topics.filter(n => n);
				let topicFinal = "<h1>Table of Contents:</h2><br>";
				for (const tpc1 of topics) {
					topicFinal += "<p>"+tpc1+"</p>";
				}
				addToBook("Table of Contents", topicFinal);
				setPage("Table of Contents");
				let i = 1;
				for (const tpc of topics) {
					console.log(tpc);
					status.textContent = `Writing page ${i}/${topics.length}`;
					let pagePrompt = fullBook() + `Above is the full contents of the chapter until now. Your job is to write a lengthy and informative section for a textbook on ${tpc} in ${topic}. Write at LEAST 2000 words and without a conclusion or concluding section. Be very lengthy, detailed, and very informative. DO NOT repeat material already covered in previous chapters. Write as much as possible on the topic, and do not be afraid of lengthy paragraphs if need be. Your content should be easy to follow for a newcomer and take the time it needs to cover a concept fully.`;
					let page = await generateResponse(pagePrompt);
					addToBook(tpc,converter.makeHtml(page));
					i+=1;
				}
				status.textContent = "Done!";
			}
			
			async function addPage() {
				let tpc = document.getElementById("newPageInp").value;
				if (tpc == "") { return; }
				status.textContent = `Adding page`;
				let pagePrompt = fullBook() + `Above is the full contents of the chapter until now. Your job is to write a lengthy and informative section for a textbook on ${tpc}. Write at LEAST 2000 words and without a conclusion or concluding section. Be very lengthy, detailed, and very informative. DO NOT repeat material already covered in previous chapters. Write as much as possible on the topic, and do not be afraid of lengthy paragraphs if need be.`;
				let page = await generateResponse(pagePrompt);
				addToBook(tpc,converter.makeHtml(page));
				status.textContent = `Done!`;
			}
			
			async function generateResponse(prompt, depth) {
				//const prompt = textbox.value;
				if (depth == null) {
					depth = 0;
				}
				let contents = "";
				try {
					console.log(prompt);
					const result = await model.generateContentStream(prompt);
					
					// Print text as it comes in.
					for await (const chunk of result.stream) {
						const chunkText = chunk.text();
						contents += chunkText;
					}
					//console.log("getting here!" + contents);
					playSound("noise.wav");
				} catch (error) {
					if (depth < 3) {
						contents = generateResponse(prompt,depth+1);
					}
					else {
						return "Uh oh! There was an issue generating this page. The issue is most likely the RECITATION error, which is a known problem. Google is working on fixing this known and sizable error.";
					}
				}
				
				return contents;
			}
			
			window.addEventListener("load", (event) => {
			  body = document.getElementById("textgohere");
			  textbox = document.getElementById("inp");
			  textbox.value = startingPrompts[[Math.floor(Math.random()*startingPrompts.length)]];
			  status = document.getElementById("status");
			  document.getElementById("btn").addEventListener("click",generateBook);
			  document.getElementById("printBtn").addEventListener("click",printPDF);
			  document.getElementById("newPageButton").addEventListener("click",addPage);
			  document.getElementById("quantity").value = "5"; 
			  
			  document.getElementById('pagedict').addEventListener("change", function() {
				document.getElementById('tab1').click();
				setPage(document.getElementById('pagedict').value);
			  });
			});
			
			const elabTooltip = document.querySelector(".elaborate-tooltip");
			document.addEventListener("mouseup", () => {
				requestAnimationFrame(() => {
					const selection = window.getSelection();
					const text = selection.toString().replace(/\s/g, "");
					let chat = document.getElementById("chatgohere");
					if (!(body.textContent.replace(/\s/g, "").includes(text)||chat.textContent.replace(/\s/g, "").includes(text))) {
						elabTooltip.style.display = "none";
						return;
					}
					
					if (selection.isCollapsed) {
						elabTooltip.style.display = "none";
						return;
					}
					
					const rect = selection.getRangeAt(0).getBoundingClientRect();
					elabTooltip.style.display = 'block';
					elabTooltip.style.left = `${rect.left + rect.width/2 - elabTooltip.clientWidth/2}px`;
					elabTooltip.style.top = `${rect.top - elabTooltip.clientHeight + window.scrollY}px`;
				});
			});
			
			window.onscroll = function (e)
			{
				elabTooltip.style.display = "none";
			}
			
			const chatButton = document.getElementById("chatButton");
			chatButton.addEventListener("click", async function() {
				let text = document.getElementById("chatInp").value;
				let pr = `${text}\n\nAnswer the above information. Be thorough and detailed and include at least 500 words. Refer back to the contents of the below book: \n\n${fullBook()}`;
				document.getElementById("chatgohere").innerHTML = `<h1>Awaiting response...</h1>`;
				const result = await model.generateContentStream(pr);
				let contents = "";
				// Print text as it comes in. This is a deviation from the standard function.
				for await (const chunk of result.stream) {
					const chunkText = chunk.text();
					contents += chunkText;
					document.getElementById("chatgohere").innerHTML = converter.makeHtml(contents);
				}
				playSound("noise.wav");
			});
			
			const elabButton = document.querySelector(".elaborate-button");
			elabButton.addEventListener("mousedown", async function() {
				const selection = window.getSelection();
				const selectedText = selection.toString();
				let pr = `${selectedText} \n\n Elaborate on the above text. Provide details and include at least 500 words. Be thorough. Refer back to the contents of the below book: \n\n${fullBook()}`;
				document.getElementById('tab2').click();
				document.getElementById("chatgohere").innerHTML = `<h1>Elaborating...</h1>`;
				const result = await model.generateContentStream(pr);
				let contents = "";
				// Print text as it comes in. This is a deviation from the standard function.
				for await (const chunk of result.stream) {
					const chunkText = chunk.text();
					contents += chunkText;
					document.getElementById("chatgohere").innerHTML = converter.makeHtml(contents);
				}
				playSound("noise.wav");
			});
			
			const pracButton = document.querySelector(".practice-button");
			pracButton.addEventListener("mousedown", async function() {
				const selection = window.getSelection();
				const selectedText = selection.toString();
				let pr = `${selectedText} \n\n Create a free-form practice problem using the concepts described in the provided text.`;
				document.getElementById('tab4').click();
				document.getElementById("question").innerHTML = `<h1>Elaborating...</h1>`;
				const result = await model.generateContentStream(pr);
				let contents = "";
				// Print text as it comes in. This is a deviation from the standard function.
				for await (const chunk of result.stream) {
					const chunkText = chunk.text();
					contents += chunkText;
					document.getElementById("question").innerHTML = converter.makeHtml(contents);
				}
				playSound("noise.wav");
			});
			
			const answerButton = document.getElementById("answerButton");
			answerButton.addEventListener("mousedown", async function() {
				
				let text = document.getElementById("question").textContent;
				let answer = document.getElementById("answerInp").value;
				if (text.trim() == "" || answer.trim() == "") {
					alert("Uh oh! Make sure you have a question and an answer.");
					return;
				}
				let pr = `${text}\n\n\n This is a practice problem. Below is what I answered: \n\n\n ${answer} \n\n Provide feedback on my answer. Tell me if it is correct or not, and how I can further learn.`;
				document.getElementById("answer").innerHTML = `<h1>Awaiting response...</h1>`;
				const result = await model.generateContentStream(pr);
				let contents = "";
				// Print text as it comes in. This is a deviation from the standard function.
				for await (const chunk of result.stream) {
					const chunkText = chunk.text();
					contents += chunkText;
					document.getElementById("answer").innerHTML = converter.makeHtml(contents);
				}
				playSound("noise.wav");
			});
			
			function printPDF() {
				printDiv(converter.makeHtml(fullBook()), "Book");
			}
			
		</script>
		<div class="elaborate-tooltip">
			<div class="elaborate-button">Elaborate</div><div class="practice-button">Practice</div>
		</div>
		<div class="wrapper">
			<div class="sidebar">
				<div class="sections">
					<div class="section">
						<div id="fields">
						<h1>AI Textbooks</h1>
						
						<label for="imp">Chapter Topic:</label>
						<br>
						<textarea rows="5" style=" width: 90%; resize:none;" maxlength="180" placeholder="Prompt goes here..." id="inp"></textarea>
						<br>
						<br>
						<label for="quantity">Page Number (3-10):</label>
						<input type="number" id="quantity" name="quantity" min="3" max="10" onkeyup="if(value<3) value=3; if (value > 10) value = 10;"><br><br>
						</div>
						
						<button id="btn" class="animBtn"><h3>Generate</h3></button>
						<br>
						<select id="pagedict" Name="Table of Contents" size="10">
						</select>  
						<br>
						<div id="newPage">
							<input id="newPageInp"></input>
							<button id="newPageButton" class="animBtn">Add Page</button>
						
						</div>
						<br>
						<div id="status">Idle!</div>
					</div>
					
				</div>
			</div>
			<div id="body">
				<div class="container">
					<input type="radio" name="tab" id="tab1" checked>
					<label class="tab" for="tab1">Book</label>
					<input type="radio" name="tab" id="tab2">
					<label class="tab" for="tab2">Chat</label>
					<input type="radio" name="tab" id="tab4">
					<label class="tab" for="tab4">Practice</label>
					<input type="radio" name="tab" id="tab3">
					<label class="tab" for="tab3">Options</label>
					<div class="content1" id="content1">
						<div id="textgohere">
						The contents of your book will appear here!
						</div>
					</div>
					<div class="content2" id="chat">
						<div id="chatInputs">
							<textarea rows="5" style="width: 80%; resize:none;" placeholder="Your question goes here!" id="chatInp"></textarea>
							<br>
							<button id="chatButton">Ask!</button>
						</div>
						<br>
						<div id="chatgohere">
							Pretty UI coming soon! Try sending a message.
						</div>
					</div>
					<div class="content4" id="content4">
						<div>
							<div id="question">Question</div>
						</div>
						<div id = "answerholder">
							<div id="answer">
							Answer
							</div>
							<fieldset id="answerSection">
								<textarea id="answerInp" rows="5" style="width: 80%; resize:none;" placeholder="Your answer goes here!">
								
								</textarea>
								<button class="animBtn2" id="answerButton">Send</button>
							</fieldset>
						</div>
					</div>
					<div class="content3" id="content3">
						<button class="animBtn" style="width: 25%; font-size: 16px;" id="printBtn">Print book as PDF</button>
						
						<h2>Changelog</h2>
						<ul>
							<li>Improved Chat mode prompting. The program now has access to the full textbook when answering chat questions.</li>
							<li>The tooltip will now appear when highlighting text in the Chat menu</li>
							<li>Minor UI revisions</li>
						</ul>
						<p>A.P. 9/03/2024</p>
					</div>
					
					
			</div>
		</div>
		
		

		
	</body>

	
	
</html>